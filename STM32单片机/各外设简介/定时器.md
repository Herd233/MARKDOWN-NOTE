# STM32定时器
>***"STM32 的每个通用定时器都是完全独立的，没有互相共享的任何资源。"***
## 简介 

STM32 的通用定时器是一个通过可编程预分频器（PSC）驱动的 16 位自动装载计数器（CNT）构成。

通用定时器用途：测量输入信号的脉冲长度(输入捕获)或者产生输出波形(输出比较和PWM)等。

## 通用定时器功能
STM32的通用定时器（即TIMx）功能包括：
>1. 16 位向上、向下、向上/向下自动装载计数器（TIMx_CNT）。
>
>2. 16 位可编程(可以实时修改)预分频器(TIMx_PSC)，计数器时钟频率的分频系数为 1～65535 之间的任意数值。
>3. 4 个独立通道（TIMx_CH1~4），这些通道可以用来作为：
>
>        A．输入捕获
> 
>        B．输出比较
>
>        C．PWM 生成(边缘或中间对齐模式)
> 
>        D．单脉冲模式输出
>4. 可使用外部信号（TIMx_ETR）控制定时器和定时器互连（可以用 1 个定时器控制另外一个定时器）的同步电路。
>
>5. 如下事件发生时产生中断/DMA：
>
>        A．更新：计数器向上溢出/向下溢出，计数器初始化(通过软件或者内部/外部触发)
>
>        B．触发事件(计数器启动、停止、初始化或者由内部/外部触发计数)
>
>        C．输入捕获
>
>        D．输出比较
>
>        E．支持针对定位的增量(正交)编码器和霍尔传感器电路
>
>        F．触发输入作为外部时钟或者按周期的电流管理

## 输入捕获功能
***定时器的输入捕获有两种模式，分别是直接捕获模式和间接捕获模式：***

**直接捕获:** 只能捕获本身通道的脉冲信号;

**间接捕获：** 可以捕获此定时器每个通道的脉冲信号;


***利用定时器可以实现PWM频率与占空比的测量，操作思路如下：***

**捕获频率：** 先初始化定时器并开启定时器，开启定时器输入捕获上升沿中断，定时器一直计数，直到捕获到上升沿，说明过了一个周期，读取计数值，读取完然后清零，等待读取下一个周期，乘以时钟频率，就是周期，然后计算PWM频率。

**捕获占空比：** 利用此定时器的另一个通道，作为间接捕获模式，读取下降沿，产生下降沿中断，读取此定时器的计数值，就是占空比的高电平时间。

另一种方法（使用单通道）：在第一次读取到上升沿并读取数据后，将触发方式改为下降沿触发，并读取第二次数据，然后将触发方式再改回上升沿触发，循环往复。

## 输出PWM功能
在PWM输出中，主要用到下面这四个寄存器:

>* 计数器寄存器（TIMx_CNT）
>* 预分频器寄存器（TIMx_PSC）
>* 自动装载寄存器(TIMx_ARR)
>* 捕获/比较寄存器（TIMx_CCR）

对于PWM的输出，一般可以用向上计数模式来实现，具体原理如下：计数值会按照设定的频率（根据预分频器寄存器的值得到设定频率）来计数（计数值存在计数器寄存器中），当计数值（计数器寄存器中的值）达到与自动装载寄存器中的值相等时，会触发一次中断，并重新从零计数，周而复始。

计数值（计数器寄存器）还会与CCR（捕获/比较寄存器）进行对比，共有两种模式：

* **PWM模式1:** 在向上计数时，一旦TIMx_CNT<TIMx_CCR时通道为有效电平，否则为无效电平；在向下计数时，一旦TIMx_CNT>TIMx_CCR时通道为无效电平，否则为有效电平。

* **PWM模式2:** 在向上计数时，一旦TIMx_CNT<TIMx_CCR时通道为无效电平，否则为有效电平；在向下计数时，一旦TIMx_CNT>TIMx_CCR时通道为无效电平，否则为有效电平。

*CC寄存器的值：0：高电平为有效    1：低电平为有效*

通过调整捕获/比较寄存器与自动装载寄存器的值，便可以灵活的调整PWM的占空比与频率。

### 一些疑惑

输出比较模式跟PWM输出模式有什么区别？

>PWM模式: ARR设置频率，CCR设置占空比，频率和占空比可以任意设置，起始相位不能设置。
>
>输出比较模式：ARR设置频率，CCR设置相位，频率和起始相位可以任意设置，占空比不能设置。输出频率为理论计算值一半。


## 常用参数计算

**Duty(占空比):**

$Duty=\frac{Pulse*100}{arr}$

**Fre(频率):**

$Fre=\frac{总线频率}{pre * arr}$

## 参考文献

> [1] 定时器周期计算公式 https://blog.csdn.net/weixin_30457465/article/details/96171032
>
>[2] 定时器TIM和PWM的输出 https://blog.csdn.net/huangyangquan/article/details/78819941
>
>[3] STM32的TIM中的OCMode设置 http://blog.sina.com.cn/s/blog_be25f0c101017qfs.html
>
>[4] 关于PWM输出的，图中的设置的，TIM1脉冲宽度调制模式2与其他模式有什么区别？ https://bbs.csdn.net/topics/390531641 
>
>[5] PWM模式配置的基础学习 https://blog.csdn.net/weixin_44599681/article/details/115363160
>
>[6] STM32输出PWM时,PWM1和PWM2的区别 https://blog.csdn.net/kinsno/article/details/46763243
>
>[7] STM32输出比较模式和PWM模式比较] https://blog.csdn.net/qq_20222919/article/details/106564957